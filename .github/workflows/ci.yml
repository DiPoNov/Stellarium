name: "Сборка Stellarium для Windows"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # Шаг 1: Клонирование репозитория
      - name: Клонирование репозитория
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Шаг 2: Установка Qt (ИСПРАВЛЕННАЯ ВЕРСИЯ)
      - name: Установка Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.6.2'  # Более новая версия, лучше совместимость
          host: 'windows'
          target: 'desktop' 
          arch: 'win64_msvc2019_64'
          modules: 'qtbase qttools qtmultimedia qtserialport'

      # Шаг 3: Конфигурация CMake
      - name: Конфигурация CMake
        shell: pwsh
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="$env:QT_DIR" `
            "${{ github.workspace }}"

      # Шаг 4: Сборка
      - name: Сборка
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 2

      # Шаг 5: Проверка что собралось
      - name: Проверка сборки
        shell: pwsh
        run: |
          echo "=== Поиск stellarium.exe ==="
          Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue
          
          $exeFile = Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            echo "✅ stellarium.exe найден: $($exeFile.FullName)"
            echo "Размер файла: $($exeFile.Length) байт"
          } else {
            echo "❌ stellarium.exe не найден"
            echo "=== Все exe файлы в build ==="
            Get-ChildItem -Path build -Recurse -Include "*.exe" -ErrorAction SilentlyContinue
          }

      # Шаг 6: Создание пакета (только если сборка успешна)
      - name: Создание дистрибутива
        shell: pwsh
        run: |
          $exeFile = Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exeFile) {
            Write-Error "stellarium.exe не найден, пропускаем создание пакета"
            exit 0
          }
          
          $exeDir = $exeFile.DirectoryName
          $distDir = "stellarium-package"
          
          New-Item -ItemType Directory -Path $distDir -Force
          
          # Копируем основные файлы
          Copy-Item -Path "$exeDir/*.exe" -Destination $distDir/
          Copy-Item -Path "$exeDir/*.dll" -Destination $distDir/ -ErrorAction SilentlyContinue
          
          # Создаем ZIP
          Compress-Archive -Path "$distDir/*" -DestinationPath "stellarium-windows.zip"

      # Шаг 7: Загрузка артефакта
      - name: Загрузка результата
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: stellarium-windows
          path: stellarium-windows.zip
          retention-days: 7
