name: "Сборка Stellarium для Windows"

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # Шаг 1: Клонирование репозитория
      - name: Клонирование репозитория
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Шаг 2: Установка Qt с ВСЕМИ нужными модулями для Stellarium
      - name: Установка Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          # Добавляем ВСЕ модули которые могут понадобиться Stellarium
          modules: 'qtcharts qtscript'

      # Шаг 3: Конфигурация CMake
      - name: Конфигурация CMake
        shell: pwsh
        run: |
          mkdir build
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="$env:QT_DIR" `
            "${{ github.workspace }}"

      # Шаг 4: Сборка
      - name: Сборка
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 4

      # Шаг 5: Проверка сборки
      - name: Проверка сборки
        shell: pwsh
        run: |
          $exeFiles = Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue
          if ($exeFiles) {
            echo "✅ Успешно! Найдены файлы:"
            $exeFiles | Format-Table FullName, Length
          } else {
            echo "❌ stellarium.exe не найден"
            echo "=== Все exe файлы ==="
            Get-ChildItem -Path build -Recurse -Include "*.exe" -ErrorAction SilentlyContinue
          }
      # Шаг 5: Поиск windeployqt и копирование зависимостей
      - name: Копирование зависимостей Qt
        if: success()
        shell: pwsh
        run: |
          $exeFile = Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            echo "Найден stellarium.exe: $($exeFile.FullName)"
            
            # Ищем windeployqt в нескольких возможных местах
            $windeployqtPaths = @(
              "$env:QT_DIR/bin/windeployqt.exe",
              "$env:QT_DIR/../../Tools/QtInstallerFramework/4.*/bin/windeployqt.exe",
              "$env:QT_DIR/../bin/windeployqt.exe"
            )
            
            $windeployqt = $null
            foreach ($path in $windeployqtPaths) {
              if (Test-Path $path) {
                $windeployqt = (Get-ChildItem $path).FullName
                break
              }
            }
            
            if (-not $windeployqt) {
              # Если не нашли, ищем рекурсивно
              $windeployqt = Get-ChildItem -Path "C:\" -Recurse -Include "windeployqt.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($windeployqt) {
                $windeployqt = $windeployqt.FullName
              }
            }
            
            if ($windeployqt) {
              echo "Найден windeployqt: $windeployqt"
              & "$windeployqt" --release --compiler-runtime "$($exeFile.FullName)"
            } else {
              echo "Предупреждение: windeployqt не найден, зависимости Qt не скопированы"
              echo "Поиск вручную:"
              Get-ChildItem -Path "$env:QT_DIR" -Recurse -Include "windeployqt.exe" -ErrorAction SilentlyContinue
            }
          }

      # Шаг 6: Ручное копирование DLL (на случай если windeployqt не сработал)
      - name: Ручное копирование зависимостей
        if: success()
        shell: pwsh
        run: |
          $exeFile = Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            $exeDir = $exeFile.DirectoryName
            echo "Копируем DLL из Qt в папку с exe: $exeDir"
            
            # Копируем основные DLL из Qt
            $qtBinPath = "$env:QT_DIR/bin"
            if (Test-Path $qtBinPath) {
              $dlls = @(
                "Qt5Core.dll", "Qt5Gui.dll", "Qt5Widgets.dll", 
                "Qt5Network.dll", "Qt5OpenGL.dll", "Qt5PrintSupport.dll",
                "Qt5Svg.dll", "Qt5Script.dll", "Qt5Charts.dll"
              )
              
              foreach ($dll in $dlls) {
                if (Test-Path "$qtBinPath/$dll") {
                  Copy-Item -Path "$qtBinPath/$dll" -Destination $exeDir -ErrorAction SilentlyContinue
                  echo "Скопирован: $dll"
                }
              }
              
              # Копируем папки с плагинами
              $pluginSrc = "$env:QT_DIR/plugins"
              if (Test-Path $pluginSrc) {
                $pluginDirs = @('platforms', 'iconengines', 'imageformats', 'styles')
                foreach ($dir in $pluginDirs) {
                  if (Test-Path "$pluginSrc/$dir") {
                    Copy-Item -Recurse -Path "$pluginSrc/$dir" -Destination $exeDir -ErrorAction SilentlyContinue
                    echo "Скопирована папка плагинов: $dir"
                  }
                }
              }
            }
          }

      # Шаг 7: Создание дистрибутива
      - name: Создание пакета
        if: success()
        shell: pwsh
        run: |
          $exeFile = Get-ChildItem -Path build -Recurse -Include "stellarium.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            $exeDir = $exeFile.DirectoryName
            $distDir = "stellarium-dist"
            
            New-Item -ItemType Directory -Path $distDir -Force
            
            # Копируем все содержимое папки с exe
            Copy-Item -Path "$exeDir/*" -Destination $distDir/ -Recurse -Force
            
            # Создаем ZIP
            $version = if ($env:GITHUB_REF -like "refs/tags/*") { 
              $env:GITHUB_REF -replace "refs/tags/v", "" 
            } else { 
              "dev-$($env:GITHUB_SHA.Substring(0, 7))" 
            }
            Compress-Archive -Path "$distDir/*" -DestinationPath "stellarium-$version-windows-x64.zip"
            
            # Показываем что упаковали
            echo "Содержимое дистрибутива:"
            Get-ChildItem -Path $distDir -Recurse | Format-Table Name, Length
          }

      # Шаг 8: Загрузка артефакта
      - name: Загрузка результата
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: stellarium-windows
          path: stellarium-*-windows-x64.zip
          retention-days: 30
