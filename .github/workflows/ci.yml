name: Build Stellarium Windows

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Позволяет запускать сборку вручную кнопку

env:
  BUILD_TYPE: Release
  QT_VERSION: '5.15.2'             # Версия Qt (как у тебя в старом скрипте)
  QT_ARCH: 'win64_msvc2019_64'     # Архитектура

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1. Забираем код репозитория со всеми подмодулями
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. Устанавливаем Qt
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'windows'
          target: 'desktop'
          arch: ${{ env.QT_ARCH }}
          modules: 'qtcharts qtscript'
          cache: true # Кэширование ускорит повторные сборки

      # 3. Настраиваем окружение для сборки (MSVC)
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 4. Конфигурация CMake
      # Мы указываем установить Stellarium в папку ./dist
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -B build -G "NMake Makefiles" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_INSTALL_PREFIX="./dist" `
            -DENABLE_MEDIA_SCRIPTING=OFF `
            -DCMAKE_PREFIX_PATH=$env:QT_ROOT_DIR

      # 5. Сборка проекта
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 4

      # 6. "Установка" в локальную папку
      # Это соберет exe и все ресурсы Stellarium в папку ./dist
      - name: Install to local directory
        run: cmake --install build --config ${{ env.BUILD_TYPE }}

      # 7. Автоматическое подтягивание DLL (Windeployqt)
      # Самый важный шаг. Он сам найдет нужные DLL Qt и положит их рядом с exe
      - name: Deploy Qt Dependencies
        shell: pwsh
        run: |
          $exePath = "./dist/bin/stellarium.exe"
          echo "Deploying Qt binaries for $exePath..."
          windeployqt --release --no-translations --compiler-runtime --dir "./dist/bin" $exePath

      # 8. Упаковка в ZIP
      - name: Pack Artifacts
        shell: pwsh
        run: |
          $packageName = "stellarium-windows-x64-${{ github.sha }}".Substring(0, 28)
          Compress-Archive -Path "./dist/bin/*" -DestinationPath "${packageName}.zip"

      # 9. Загрузка результата в GitHub Actions
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stellarium-Build
          path: "*.zip"
          retention-days: 7
